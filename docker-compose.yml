version: "3"
name: septs

volumes:
  git_data:
  ssl_data:
  tor_data:
  vpn_data:

services:

  # DDNS+HTTPS reverse proxy
  d3rp:
    build: ./d3rp
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    volumes:
      - ssl_data:/etc/letsencrypt
    environment:
      SUBDOMAINS: ${SUBDOMAINS}
      DOMAIN_NAME: ${DOMAIN_NAME}
      DOMAIN_EMAIL: ${DOMAIN_EMAIL}
      CF_API_TOKEN: ${CF_API_TOKEN}
      CF_ZONE: ${CF_ZONE}
      CF_A_RECORD: ${CF_A_RECORD}
      CF_AAAA_RECORD: ${CF_A_RECORD}

  # Git server with static site generator
  src:
    build: ./septs_git
    restart: unless-stopped
    volumes:
      - git_data:/git

  # TODO
  #sync:
  #  build: ./septs_sync
  #  restart: unless-stopped
  #  volumes:
  #    - sync_data:/sync

  # TODO
  #tor:
  #  build: ./septs_tor
  #  restart: unless-stopped
  #  volumes:
  #    - tor_data:/etc/nginx/certs

  # Provide a secure VPN service to access local network resources
  # TODO: doesn't feel secure yet
  #vpn:
  #  build: ./septs_vpn
  #  restart: unless-stopped
  #  ports:
  #    - 1194:1194/udp
  #  volumes:
  #    - vpn_data:/etc/openvpn
  #  devices:
  #   - /dev/net/tun:/dev/net/tun
  #  cap_add:
  #   - NET_ADMIN
  #  environment:
  #    SRV_DOMAIN: ${SRV_DOMAIN}
  #  profiles:
  #    - donotstart

  # Primary web server behind reverse proxy
  www:
    build: ./septs_www
    restart: unless-stopped
    # TODO: temporary
    stop_signal: SIGKILL
