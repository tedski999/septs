version: "3"
name: septs

volumes:
  git_data:
  ssl_data:
  tor_data:
  vpn_data:

services:

  # Keep Cloudflare DNS records updated with current public IP address
  ddns:
    build: ./septs_ddns
    restart: unless-stopped
    environment:
      CF_API_TOKEN: ${CF_API_TOKEN}
      CF_ZONE: ${CF_ZONE}
      CF_A_RECORD: ${CF_A_RECORD}
      CF_AAAA_RECORD: ${CF_A_RECORD}

  # Git server with static site generator
  git:
    build: ./septs_git
    restart: unless-stopped
    volumes:
      - git_data:/git

  # TLS reverse proxy between internet and local HTTP web servers
  proxy:
    build: ./septs_proxy
    restart: unless-stopped
    stop_signal: SIGQUIT
    ports:
      - 80:80
      - 443:443
    volumes:
      - ssl_data:/etc/nginx/certs
      # TODO: replace tmeporary solution
      - git_data:/git

  # Automatically register and renew SSL certificates for this domain
  ssl:
    build: ./septs_ssl
    restart: unless-stopped
    volumes:
      - ssl_data:/etc/letsencrypt
    environment:
      CF_API_TOKEN: ${CF_API_TOKEN}
      SRV_DOMAIN: ${SRV_DOMAIN}
      SRV_EMAIL: ${SRV_EMAIL}

  # TODO
  #sync:
  #  build: ./septs_sync
  #  restart: unless-stopped
  #  volumes:
  #    - sync_data:/sync

  # TODO
  #tor:
  #  build: ./septs_tor
  #  restart: unless-stopped
  #  volumes:
  #    - tor_data:/etc/nginx/certs

  # Provide a secure VPN service to access local network resources
  # TODO: doesn't feel secure yet
  vpn:
    build: ./septs_vpn
    restart: unless-stopped
    ports:
      - 1194:1194/udp
    volumes:
      - vpn_data:/etc/openvpn
    devices:
     - /dev/net/tun:/dev/net/tun
    cap_add:
     - NET_ADMIN
    environment:
      SRV_DOMAIN: ${SRV_DOMAIN}
    profiles:
      - donotstart

  # Primary web server behind reverse proxy
  www:
    build: ./septs_www
    restart: unless-stopped
    # TODO: temporary
    stop_signal: SIGKILL
