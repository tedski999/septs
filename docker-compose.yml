version: "3"
name: septs

volumes:
  git_data:
  ssl_data:
  tor_data:
  vpn_data:

services:

  # Keep Cloudflare DNS records updated with current public IP address
  ddns:
    build: ./ddns
    restart: unless-stopped
    environment:
      CF_API_TOKEN: ${CF_API_TOKEN}
      CF_ZONE: ${CF_ZONE}
      CF_A_RECORD: ${CF_A_RECORD}
      CF_AAAA_RECORD: ${CF_A_RECORD}

  # A git server for personal projects
  git:
    build: ./git
    restart: on-failure:5
    volumes:
      - git_data:/todo

  # Tor onion service
  tor:
    build: ./tor
    restart: unless-stopped
    volumes:
      - tor_data:/etc/nginx/certs
    profiles:
      - donotstart

  # TLS reverse proxy between internet and local HTTP web server
  proxy:
    build: ./proxy
    restart: unless-stopped
    stop_signal: SIGQUIT
    ports:
      - 80:80
      - 443:443
    volumes:
      - ssl_data:/etc/nginx/certs
      - /var/run/docker.sock:/tmp/docker.sock:ro

  # Static web server containing HTML generated from local git repositories
  site.src:
    build: ./site/src
    restart: unless-stopped
    # TODO: graceful shutdown
    stop_signal: SIGKILL
    volumes:
      - git_data:/git

  # Personal webserver as my homepage and blog
  site.www:
    build: ./site/www
    restart: unless-stopped
    # TODO: graceful shutdown
    stop_signal: SIGKILL

  # Automatically register and renew SSL certificates for this domain
  ssl:
    build: ./ssl
    restart: unless-stopped
    volumes:
      - ssl_data:/etc/letsencrypt
    environment:
      CF_API_TOKEN: ${CF_API_TOKEN}
      SRV_DOMAIN: ${SRV_DOMAIN}
      SRV_EMAIL: ${SRV_EMAIL}

  # Provide a secure VPN service to access local network resources
  vpn:
    build: ./vpn
    restart: unless-stopped
    ports:
      - 1194:1194/udp
    volumes:
      - vpn_data:/etc/openvpn
    devices:
     - /dev/net/tun:/dev/net/tun
    cap_add:
     - NET_ADMIN
    environment:
      SRV_DOMAIN: ${SRV_DOMAIN}
    profiles:
      - donotstart
